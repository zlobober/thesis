\chapter{Модельный алгоритм}

Установленных фактов хватает, чтобы оформить алгоритм вычисления всех значений предиката $2DSP$ в виде псевдокода (алгоритм \ref{alg:main}). 

\begin{algorithm}
\caption{Вычисление всех значений $2DSP(s_1, t_1, s_2, t_2)$ за $O(|V|^8)$} \label{alg:main}
\begin{algorithmic}[1]
\Procedure{CalculateAll2DSPValues}{$V$, $E$}
\State $l \gets \text{матрица попарных расстояний между вершинами в }G$; \label{line:floyd}
\LineComment{Разобьём пары вершин на группы в соответствии с расстояними между ними.}
\State $P_i \gets \text{пустой список для всех }i = 0, \ldots, |V|-1$;
\For{$s,t \in V$}
    \State $\text{добавляем }(s, t)\text{ в конец списка }P_{l(s, t)}$;
\EndFor
\LineComment{Вычислим значения предиката в порядке лексикографического возрастания}
\LineComment{пары $(d_{\min}, d_{\max})$, где $d_{\min}$ это меньшее из расстояний между парами терминалов,}
\LineComment{а $d_{\max}$ это большее.}
\For{$d_{\min} \gets 0, \ldots, |V|-1$}
    \For{$d_{\max} \gets d_{\min}, \ldots, |V|-1$}
        \For{$(s_1, t_1) \in P_{d_{\min}}$}
            \For{$(s_2, t_2) \in P_{d_{\max}}$}
                \State $2DSP(s_1, t_1, s_2, t_2) \gets \textsc{CalculateSingle2DSPValue}(s_1, t_1, s_2, t_2)$;
                \State $2DSP(s_2, t_2, s_1, t_1) \gets 2DSP(s_1, t_1, s_2, t_2)$; \Comment{по симметрии}
            \EndFor
        \EndFor
    \EndFor
\EndFor
\EndProcedure
\Statex
\Procedure{CalculateSingle2DSPValue}{$s_1$, $t_1$, $s_2$, $t_2$}
\If {$s_1 = t_1 \wedge s_2 = t_2$}
    \State \Return $s_1 = s_2$; \label{line:a}
\ElsIf {$(s_1, t_1, s_2, t_2)\text{ не жёсткая четвёрка}$}
    \State \text{вычисляем и возвращаем значение в соответствии с пунктом б теоремы \ref{main_theorem}}; \label{line:b}
\Else
    \State $\text{вычисляем }Q_2(s_1, t_1, s_2, t_2)\text{ по формулам \eqref{eq:Q2}}$; \label{line:cQ2}
    \State $\text{вычисляем }Q_4(s_1, t_1, s_2, t_2)\text{ по формулам \eqref{eq:Q4}}$; \label{line:cQ4}
    \State \Return $Q_2(s_1, t_1, s_2, t_2) \vee Q_4(s_1, t_1, s_2, t_2)$;
\EndIf
\EndProcedure
\end{algorithmic}
\end{algorithm}

Прокомментируем временную сложность всех составных частей алгоритма.

\begin{proposition}
Построение матрицы кратчайших расстояний в строке \ref{line:floyd} алгоритма \ref{alg:main} можно произвести за время $\OO(|V|^3)$.
\end{proposition}
\begin{proof}
Достаточно воспользоваться алгоритмом Флойда-Уоршелла (\cite{Floyd}, \cite{CLRS}).
\end{proof}

\begin{proposition}
Процедура \textsc{CalculateSingle2DSPValue} работает за $\OO(1)$, $\OO(|V|)$ или $\OO(|V|^4)$ в зависимости от того, какой случай из теоремы \ref{main_theorem} реализуется.
\end{proposition}
\begin{proof}
Легко видеть, что строка \ref{line:a} состоит из единственной инструкции и соответствует случаю, требующему константное количество операций, строка \ref{line:b} соответствует случаю, в котором вычисление зависит от $\OO(|V|)$ четвёрок (см. пункт б теоремы \ref{main_theorem}). 

Строка \ref{line:cQ2} соответствует группе тех четвёрок вершин, от которых зависит четвёрка $(s_1, t_1, s_2, t_2)$, и которые отличаются от нашей четвёрки в двух позициях, стало быть, вычисление $Q_2(s_1, t_1, s_2, t_2)$ требует не более $\OO(|V|^2)$ операций в худшем случае.

Наконец, строка \ref{line:cQ4} соответствует группе тех четвёрок вершин, которые отличаются от четвёрки $(s_1, t_1, s_2, t_2)$ по каждой компоненте, а значит, вычисление $Q_4(s_1, t_1, s_2, t_2)$ требует не более $\OO(|V|^4)$ операций в худшем случае.
\end{proof}

Таким образом, мы получили верхнюю оценку на время работы алгоритма \ref{alg:main}, которую можно сформулировать в виде теоремы:

\begin{theorem}
Время работы алгоритма \ref{alg:main} есть $\OO(|V|^8)$.
\end{theorem}
\begin{proof}
Основное время занимают вызовы \textsc{CalculateSingle2DSPValue}, которых будет произведено ровно $|V|^4$, и каждый из которых работает за время $O(|V|^4)$.
\end{proof}

Видно, что самым узким местом в программе является вычисление $Q_4(s_1, t_1, s_2, t_2)$. Покажем также, что в худшем случае алгоритм \ref{alg:main} работает за $\Theta(|V|^8)$. Для этого достаточно предъявить семейство графов сколь угодно большого размера, для которых время работы алгоритма \ref{alg:main} есть $\Theta(|V|^8)$.

\begin{theorem}
Построим граф $G_k = (V_k, E_k)$, где 

\begin{align}
V_k &= \bigsqcup\limits_{i = 0,\ldots,7} S_i \sqcup \{c\} \\
E_k &= \bigsqcup\limits_{i = 0,\ldots,7} S_i \times S_{(i+1) \bmod 8} \quad\sqcup\quad \bigsqcup\limits_{i=1,3,5,7} S_i \times \{c\} \\
|S_i| &= k.
\end{align}

\begin{figure}[H]
\caption{Граф $G_k$}
\centering
\includegraphics[width=0.4\textwidth]{pic_n8.1}
\end{figure}

Заметим, что в данном графе $|V_k| = 12k + 1$ и $|E_k| = 12k^2 + 4k$. Тогда время работы алгоритма \ref{alg:main} на графе $G_k$ составит $\Theta(k^8) = \Theta(|V|^8)$.

\end{theorem}
\begin{proof}
Предположим, $s_1 \in S_0$, $s_2 \in S_2$, $t_1 \in S_4$, $t_2 \in S_6$. Тогда $l(s_1, t_1) = l(s_2, t_2) = 4$, $l(s_1, s_2) = l(s_2, t_1) = l(t_1, t_2) = l(t_2, s_1) = 2$, то есть, $s_1, t_1 \in L(s_2, t_2)$ и $s_2, t_2 \in L(s_1, t_1)$, а значит, $(s_1, t_1, s_2, t_2)$ --- жёсткая четвёрка вершин.

Заметим также, что если $x \in S_1$, $u \in S_3$, $y \in S_5$, $v \in S_7$, то $(s_1, t_1, s_2, t_2) \succ (x, y, u, v)$. Действительно, верны соотношения $x \in F(s_1, s_2)$, $u \in F(s_2, t_1)$, $y \in F(t_1, t_2)$, $v \in F(t_2, s_1)$, и при этом $l(x, y) = 2 = l(s_1, t_1) - 2$ и $l(u, v) = 2 = l(s_2, t_2) - 2$, значит, $(x, y, u, v)$ попадает в первое выражение формулы \ref{eq:Q4}.

Наконец заметим, что описанных наборов $(s_1, t_1, s_2, t_2, x, y, u, v)$ в точности $k^8 = \Theta(|V|^8)$, а значит, суммарное время, затраченное на исполнение строки \ref{line:cQ4} алгоритма \ref{alg:main}, составит $\Theta(|V|^8)$.
\end{proof}

Наконец, оценим память, потребляемую алгоритмом \ref{alg:main}
\begin{theorem}
Алгоритм \ref{alg:main} потребляет $\OO(|V|^4)$ памяти.
\end{theorem}
\begin{proof}
Действительно, всё потребление памяти сосредоточено в сохранении графа и матрицы кратчайших путей, на которые нужно $\OO(|V|^2)$, памяти, а также четырёхмерного массива логических значений предиката $2DSP$, на который нужно $\OO(|V|^4)$ памяти.
\end{proof}
