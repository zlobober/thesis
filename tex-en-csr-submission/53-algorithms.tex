\begin{algorithm}
\caption{Vy'chislenie vsex znachenij $2DSP(s_1, t_1, s_2, t_2)$ dlya vzveshennogo grafa za $O(|V|^7)$} \label{alg:n7w}
\begin{algorithmic}[1]
\Procedure{CalculateAll2DSPValues}{$V$, $E$, $w$}
\State $l \gets \text{matricza poparny'x rasstoyanij mezhdu vershinami v }G$;
\State Pust` vse unikal`ny'e rasstoyaniya mezhdu parami vershin v poryadke sortirovki --- $d_0, d_1, \ldots, d_{f-1}$;
\LineComment{Razob`yom pary' vershin na gruppy' v sootvetstvii s rasstoyaniyami mezhdu nimi.}
\State $P_d \gets \text{pustoj spisok dlya vsex }d = d_0, \ldots, d_{f-1}$;
\For{$s,t \in V$}
    \State $\text{dobavlyaem }(s, t)\text{ v konecz spiska }P_{l(s, t)}$;
\EndFor
\LineComment{Vy'chislim znacheniya predikata v poryadke leksikograficheskogo vozrastaniya}
\LineComment{pary' $(d_{\min}, d_{\max})$, gde $d_{\min}$ e`to men`shee iz rasstoyanij mezhdu parami terminalov,}
\LineComment{a $d_{\max}$ e`to bol`shee.}
\For{$d_{\min} \gets d_0, \ldots, d_{f-1}$}
    \State $\textsc{CalculateAllExYVValues}(d_{\min})$; \label{line:calcExYVw}
    \For{$d_{\max} \gets d_{\min}, \ldots, d_{f-1}$}
        \For{$(s_1, t_1) \in P_{d_{\min}}$}
            \For{$(s_2, t_2) \in P_{d_{\max}}$}
                \State $2DSP(s_1, t_1, s_2, t_2) \gets \textsc{CalculateSingle2DSPValue}(s_1, t_1, s_2, t_2)$;
                \State $2DSP(s_2, t_2, s_1, t_1) \gets 2DSP(s_1, t_1, s_2, t_2)$; \Comment{po simmetrii}
            \EndFor
        \EndFor
    \EndFor
\EndFor
\EndProcedure
\Statex
\Procedure{CalculateAllExYVValues}{$d$}
    \For{$(s_1,t_1 \in P_d)$}
        \For{$x \in F(s_1, t_1)$}
            \For{$u,t_2 \in V$}
                \State $ExYV(x,u,s_1,t_1,t_2) \gets 2DSP(x, F(t_1,x,t_2), u, F(t_2,u,s_1))$;
            \EndFor
        \EndFor
    \EndFor
\EndProcedure
\Statex
\Procedure{CalculateSingle2DSPValue}{$s_1$, $t_1$, $s_2$, $t_2$}
\If {$s_1 = t_1 \wedge s_2 = t_2$}
    \State \Return $s_1 = s_2$; 
\ElsIf {$(s_1, t_1, s_2, t_2)\text{ ne zhyostkaya chetvyorka}$}
    \State \text{vy'chislyaem i vozvrashhaem znachenie v sootvetstvii s punktom b teoremy' \ref{main_theorem}};
\Else
    \State $\text{vy'chislyaem }Q_2(s_1, t_1, s_2, t_2)\text{ po formulam \eqref{eq:Q2}}$; 
    \State $Q_4(s_1, t_1, s_2, t_2) = ExYV(F(s_1, t_1, s_2), F(s_2, t_2, t_1), s_1, t_1, t_2)\enspace\vee\enspace$ 
    \Statex $\hspace{4.5cm}ExYV(F(s_2, t_2, s_1), F(s_1, t_1, t_2), s_2, t_2, t_1)$;
    \State \Return $Q_2(s_1, t_1, s_2, t_2) \vee Q_4(s_1, t_1, s_2, t_2)$;
\EndIf
\EndProcedure
\end{algorithmic}
\end{algorithm}
